name: Build Suwayomi Server Native Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Xms2g -XX:MaxMetaspaceSize=1g"
  JAVA_OPTS: "-Xmx4g"

jobs:
  build-native-windows:
    name: Build Native Image for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Java with more memory
      uses: actions/setup-java@v4
      with:
        distribution: 'graalvm'
        java-version: '21'
        components: 'native-image'

    - name: Create gradle.properties with memory settings
      run: |
        echo "org.gradle.jvmargs=-Xmx4g -Xms2g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8" > gradle.properties
        echo "kotlin.daemon.jvmargs=-Xmx3g" >> gradle.properties
        echo "org.gradle.parallel=true" >> gradle.properties
        echo "org.gradle.caching=true" >> gradle.properties

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Build with Gradle (incremental)
      run: |
        .\gradlew.bat :server:compileKotlin --no-daemon --build-cache

    - name: Build JAR
      run: |
        .\gradlew.bat :server:jar --no-daemon

    - name: Find JAR file
      id: find_jar
      run: |
        $jarFile = (Get-ChildItem -Path "server\build\libs" -Filter "*.jar" | Sort-Object LastWriteTime | Select-Object -Last 1).FullName
        echo "JAR_FILE=$jarFile" >> $env:GITHUB_ENV
        echo "Jar file: $jarFile"

    - name: Build Native Image with optimized settings
      run: |
        native-image `
          -jar "$env:JAR_FILE" `
          --no-fallback `
          -H:Name=suwayomi-server `
          -H:EnableURLProtocols=http,https `
          -H:+ReportExceptionStackTraces `
          -J-Xmx6G `
          -H:InitialCollectionSize=32M `
          -H:MaxCollectionSize=128M `
          --initialize-at-build-time=org.slf4j,org.apache.log4j,kotlinx.coroutines,io.ktor,kotlin.sequences,kotlin.coroutines `
          --verbose

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: suwayomi-server-windows
        path: suwayomi-server.exe
        retention-days: 7

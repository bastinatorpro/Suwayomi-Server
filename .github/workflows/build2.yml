name: Build from Release JAR

on:
  workflow_dispatch:

jobs:
  build-native-windows:
    name: Build Native Image from Release JAR
    runs-on: windows-latest
    
    steps:
    - name: Download JAR from release
      run: |
        $jarUrl = "https://github.com/Suwayomi/Suwayomi-Server/releases/download/v2.1.1867/Suwayomi-Server-v2.1.1867.jar"
        $jarPath = "Suwayomi-Server.jar"
        Invoke-WebRequest -Uri $jarUrl -OutFile $jarPath
        echo "JAR_FILE=$jarPath" >> $env:GITHUB_ENV

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'graalvm'
        java-version: '21'
        components: 'native-image'

    - name: Check JAR manifest
      run: |
        echo "=== Checking JAR manifest ==="
        jar xf "$env:JAR_FILE" META-INF/MANIFEST.MF
        if (Test-Path "META-INF/MANIFEST.MF") {
          echo "Manifest content:"
          Get-Content "META-INF/MANIFEST.MF"
        } else {
          echo "No manifest found in JAR"
        }

    - name: Build Native Image without explicit main class
      run: |
        # Пробуем собрать без указания главного класса
        # GraalVM должен автоматически определить его из манифеста
        native-image `
          -jar "$env:JAR_FILE" `
          --no-fallback `
          -H:Name=suwayomi-server `
          -H:EnableURLProtocols=http,https,file `
          -H:+ReportExceptionStackTraces `
          -J-Xmx8G `
          -H:InitialCollectionSize=64M `
          -H:MaxCollectionSize=256M `
          --allow-incomplete-classpath `
          --verbose

    - name: Check if binary was created
      id: check_binary
      run: |
        if (Test-Path "suwayomi-server.exe") {
          echo "Binary created successfully"
          echo "BINARY_EXISTS=true" >> $env:GITHUB_ENV
        } else {
          echo "Binary was not created"
          echo "BINARY_EXISTS=false" >> $env:GITHUB_ENV
        }

    - name: Alternative approach - use native-image with auto-detection
      if: env.BINARY_EXISTS == 'false'
      run: |
        # Альтернативный подход с другими настройками
        native-image `
          -cp "$env:JAR_FILE" `
          --no-fallback `
          -H:Name=suwayomi-server `
          -H:EnableURLProtocols=http,https,file `
          -H:+ReportExceptionStackTraces `
          -H:+AddAllCharsets `
          -H:NativeLinkerOption=-Wl,--stack-size=8388608 `
          -J-Xmx8G `
          --allow-incomplete-classpath `
          --features=org.graalvm.home.HomeFinderFeature `
          --initialize-at-run-time=`
            org.jetbrains.kotlin.scripting.compiler.pl.impl,`
            org.jetbrains.kotlin.scripting.definitions `
          --verbose

    - name: Final attempt - try different JAR approach
      if: env.BINARY_EXISTS == 'false'
      run: |
        # Последняя попытка - используем другой способ указания classpath
        echo "Trying different approach..."
        java -jar "$env:JAR_FILE" --dry-run || echo "Dry run failed, but continuing..."
        
        native-image `
          -cp "$env:JAR_FILE" `
          --no-fallback `
          -H:Name=suwayomi-server `
          -H:EnableURLProtocols=http,https,file `
          -H:+ReportExceptionStackTraces `
          -J-Xmx8G `
          --allow-incomplete-classpath `
          --no-server `
          --static `
          --verbose

    - name: Upload Artifact
      if: env.BINARY_EXISTS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: suwayomi-server-windows-native
        path: suwayomi-server.exe
        retention-days: 30

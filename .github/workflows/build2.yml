name: Build Suwayomi Server Native Windows from Release JAR

on:
  workflow_dispatch:

jobs:
  build-native-windows:
    name: Build Native Image from Release JAR
    runs-on: windows-latest
    
    steps:
    - name: Download JAR from release
      run: |
        $jarUrl = "https://github.com/Suwayomi/Suwayomi-Server/releases/download/v2.1.1867/Suwayomi-Server-v2.1.1867.jar"
        $jarPath = "Suwayomi-Server.jar"
        Invoke-WebRequest -Uri $jarUrl -OutFile $jarPath
        echo "JAR_FILE=$jarPath" >> $env:GITHUB_ENV

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'graalvm'
        java-version: '21'
        components: 'native-image'

    - name: Analyze JAR structure
      run: |
        echo "=== JAR file info ==="
        echo "JAR file size: $(Get-Item $env:JAR_FILE | Select-Object -ExpandProperty Length) bytes"
        
        echo "=== Checking manifest ==="
        jar xf "$env:JAR_FILE" META-INF/MANIFEST.MF
        if (Test-Path "META-INF/MANIFEST.MF") {
          Get-Content "META-INF/MANIFEST.MF"
        }
        
        echo "=== Listing top-level directories ==="
        jar tf "$env:JAR_FILE" | Select-Object -First 50
        
        echo "=== Looking for main classes ==="
        jar tf "$env:JAR_FILE" | Where-Object { $_ -match "class$" -and $_ -match "Main|Server|Application" }

    - name: Extract and check main class
      run: |
        # Извлекаем манифест для проверки главного класса
        jar xf "$env:JAR_FILE" META-INF/MANIFEST.MF
        $mainClass = (Get-Content "META-INF/MANIFEST.MF" | Where-Object { $_ -match "Main-Class:" }) -replace "Main-Class: ", ""
        
        if ($mainClass) {
          echo "Found main class in manifest: $mainClass"
          echo "MAIN_CLASS=$mainClass" >> $env:GITHUB_ENV
        } else {
          echo "No main class found in manifest, will use common main class names"
          echo "MAIN_CLASS=org.suwayomi.tachidesk.server.TachideskServer" >> $env:GITHUB_ENV
        }

    - name: Try to run JAR with extracted main class
      run: |
        if ($env:MAIN_CLASS) {
          echo "Trying to run with main class: $env:MAIN_CLASS"
          java -cp "$env:JAR_FILE" $env:MAIN_CLASS --version || java -cp "$env:JAR_FILE" $env:MAIN_CLASS -h || echo "Cannot run directly, but will proceed with native-image"
        }

    - name: Build Native Image
      run: |
        if ($env:MAIN_CLASS) {
          $mainClassArg = "-H:Class=$env:MAIN_CLASS"
        } else {
          $mainClassArg = ""
        }
        
        native-image `
          -jar "$env:JAR_FILE" `
          --no-fallback `
          -H:Name=suwayomi-server `
          $mainClassArg `
          -H:EnableURLProtocols=http,https,file `
          -H:+ReportExceptionStackTraces `
          -J-Xmx8G `
          -H:InitialCollectionSize=64M `
          -H:MaxCollectionSize=256M `
          --initialize-at-build-time=`
            org.slf4j,`
            kotlin,`
            kotlinx.coroutines,`
            io.ktor,`
            com.fasterxml.jackson `
          --allow-incomplete-classpath `
          --verbose

    - name: Test the native binary
      run: |
        if (Test-Path "suwayomi-server.exe") {
          echo "Native binary created, testing..."
          .\suwayomi-server.exe --version || .\suwayomi-server.exe -h || .\suwayomi-server.exe || echo "Binary exists but may need specific arguments"
        } else {
          echo "Binary was not created"
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: suwayomi-server-windows-native
        path: suwayomi-server.exe
        retention-days: 30
